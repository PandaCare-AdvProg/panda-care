<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Propose Consultation Schedule</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    h2, h3 {
      color: #222;
    }
    form, .content-section, .modal {
      background: #fff;
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: 6px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 12px;
      background-color: #007bff;
      border: none;
      border-radius: 3px;
      color: #fff;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .list-item {
      background: #fff;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .modal {
      display: none;
      position: fixed;
      top: 20%;
      left: 40%;
      padding: 20px;
      background: #fff;
      border: 1px solid #ccc;
      z-index: 1000;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .rating-stars {
      display: flex;
      gap: 5px;
    }
    .btn-check:checked + .btn-outline-warning {
      background-color: #ffc107;
      color: #fff;
    }
  </style>
  <script>
    
    // Redirect to login if no JWT token is present
    if (!localStorage.getItem('token')) {
      window.location.href = '/login.html';
    }

    function logoutUser() {
      const token = localStorage.getItem('token');
      fetch('/api/v1/auth/logout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if(response.ok) {
          localStorage.removeItem('token');
          window.location.href = '/login.html';
        } else {
          alert('Logout failed');
        }
      })
      .catch(error => {
        console.error("Error during logout:", error);
        localStorage.removeItem('token');
        window.location.href = '/login.html';
      });
    }

    // Check if user is viewing a completed consultation
    function checkCompletedConsultation() {
      const urlParams = new URLSearchParams(window.location.search);
      const consultationId = urlParams.get('id');
      
      if (consultationId) {
        fetch(`/api/v1/consultations/${consultationId}`, {
          headers: getAuthHeaders()
        })
        .then(response => response.json())
        .then(consultation => {
          if (consultation.status === 'COMPLETED') {
            // Show rating section for completed consultations
            document.getElementById('ratingSection').style.display = 'block';
            document.getElementById('consultationId').value = consultationId;
            
            // Check if user already rated this consultation
            checkExistingRating(consultationId);
          }
        })
        .catch(error => console.error('Error checking consultation:', error));
      }
    }

    // Check if user already rated this consultation
    function checkExistingRating(consultationId) {
      fetch(`/api/v1/ratings/consultation/${consultationId}`, {
        headers: getAuthHeaders()
      })
      .then(response => {
        if (response.status === 200) {
          return response.json();
        }
        return null;
      })
      .then(rating => {
        if (rating) {
          // Pre-fill form with existing rating
          document.querySelector(`input[name="score"][value="${rating.score}"]`).checked = true;
          document.getElementById('review').value = rating.review;
          document.getElementById('submitRating').textContent = 'Update Rating';
          document.getElementById('ratingForm').dataset.ratingId = rating.id;
        }
      })
      .catch(error => console.error('Error checking existing rating:', error));
    }

    // Handle rating form submission (create or update)
    function handleRatingSubmit(event) {
      event.preventDefault();
      
      const ratingId = this.dataset.ratingId;
      const consultationId = document.getElementById('consultationId').value;
      const score = document.querySelector('input[name="score"]:checked').value;
      const review = document.getElementById('review').value;
      
      const url = ratingId 
        ? `/api/v1/ratings/${ratingId}` 
        : '/api/v1/ratings';
        
      const method = ratingId ? 'PUT' : 'POST';
      
      const data = ratingId 
        ? { score: parseInt(score), review } 
        : { consultationId, score: parseInt(score), review };
      
      fetch(url, {
        method: method,
        headers: getAuthHeaders(),
        body: JSON.stringify(data)
      })
      .then(response => {
        if (response.ok) {
          alert(ratingId ? 'Rating updated successfully!' : 'Rating submitted successfully!');
          window.location.reload();
        } else {
          throw new Error('Failed to submit rating');
        }
      })
      .catch(error => {
        console.error('Error with rating:', error);
        alert('Failed to process rating. Please try again.');
      });
    }

  </script>
</head>
<body>
  <nav id="navbar">
    <button onclick="logoutUser()">Logout</button>
  </nav>
  <section class="content-section">
    <h2>Propose a Consultation Schedule</h2>
    <form id="createConsultationForm">
      <label>
        Select Doctor:
        <select name="doctorId" required>
          <!-- Options will be loaded dynamically -->
        </select>
      </label>
      <label>
        Select Available Schedule:
        <select name="scheduleId" required>
          <!-- Options will be loaded dynamically based on selected doctor -->
        </select>
      </label>
      <label>
        Meeting URL:
        <input type="url" name="meetingUrl">
      </label>
      <label>
        Additional Notes:
        <textarea name="notes" rows="3"></textarea>
      </label>
      <button type="submit">Send Consultation Request</button>
    </form>
    <div id="consultationResult"></div>
  </section>

  <section class="content-section">
    <h2>Your Consultation History</h2>
    <div id="consultationHistory">
    </div>
  </section>

  <div id="editScheduleModal" class="modal">
    <h3>Select a New Schedule</h3>
    <select id="modalScheduleSelect">
    </select>
    <button id="modalSubmitBtn">Save Changes</button>
    <button id="modalCancelBtn">Cancel</button>
  </div>

  <!-- Rating section  -->
  <div id="ratingSection" style="display: none;">
    <div class="card mt-4">
      <div class="card-header">
        <h4>Rate Your Doctor</h4>
      </div>
      <div class="card-body">
        <form id="ratingForm">
          <input type="hidden" id="consultationId" name="consultationId">
          
          <div class="form-group mb-3">
            <label>Your Rating:</label>
            <div class="rating-stars">
              <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="score" id="score1" value="1" autocomplete="off">
                <label class="btn btn-outline-warning" for="score1">1★</label>
                
                <input type="radio" class="btn-check" name="score" id="score2" value="2" autocomplete="off">
                <label class="btn btn-outline-warning" for="score2">2★</label>
                
                <input type="radio" class="btn-check" name="score" id="score3" value="3" autocomplete="off">
                <label class="btn btn-outline-warning" for="score3">3★</label>
                
                <input type="radio" class="btn-check" name="score" id="score4" value="4" autocomplete="off">
                <label class="btn btn-outline-warning" for="score4">4★</label>
                
                <input type="radio" class="btn-check" name="score" id="score5" value="5" autocomplete="off" checked>
                <label class="btn btn-outline-warning" for="score5">5★</label>
              </div>
            </div>
          </div>
          
          <div class="form-group mb-3">
            <label for="review">Your Review:</label>
            <textarea class="form-control" id="review" name="review" rows="3" 
                      placeholder="Share your experience with this doctor"></textarea>
          </div>
          
          <div class="text-end">
            <button type="submit" class="btn btn-primary" id="submitRating">Submit Rating</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Helper to get auth headers
    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      return {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      };
    }
    
    // Load doctors and populate select
    async function loadDoctors() {
      try {
        const response = await fetch('/api/doctors', { headers: getAuthHeaders() });
        const doctors = await response.json();
        const doctorSelect = document.querySelector('select[name="doctorId"]');
        doctorSelect.innerHTML = '';
        doctors.forEach(doctor => {
          const option = document.createElement('option');
          option.value = doctor.id;
          option.textContent = doctor.email || `Doctor ${doctor.id}`;
          doctorSelect.appendChild(option);
        });
        if (doctorSelect.value) {
          loadSchedulesForDoctor(doctorSelect.value);
        }
      } catch (error) {
        console.error('Error loading doctors', error);
      }
    }
    
    // Load available schedules for a given doctor
    async function loadSchedulesForDoctor(doctorId) {
      try {
        const response = await fetch(`/api/schedules/doctor/${doctorId}`, { headers: getAuthHeaders() });
        const schedules = await response.json();
        const scheduleSelect = document.querySelector('select[name="scheduleId"]');
        scheduleSelect.innerHTML = '';
        schedules.filter(schedule => schedule.status === "AVAILABLE")
                 .forEach(schedule => {
          const option = document.createElement('option');
          option.value = schedule.id;
          option.textContent = schedule.timeslot || `Schedule ${schedule.id}`;
          scheduleSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading schedules', error);
      }
    }
    
    // Submit new consultation request
    document.getElementById('createConsultationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        doctor: { id: form.doctorId.value },
        schedule: { id: form.scheduleId.value },
        meetingUrl: form.meetingUrl.value,
        notes: form.notes.value
      };
      const response = await fetch('/api/consultations', {
        method: 'POST',
        headers: getAuthHeaders(),
        body: JSON.stringify(data)
      });
      const result = await response.json();
      document.getElementById('consultationResult').innerText = JSON.stringify(result, null, 2);
      loadConsultationHistory();
    });
    
    // Load patient profile
    async function loadPatientProfile() {
      const response = await fetch('/api/patients/me', { headers: getAuthHeaders() });
      if (!response.ok) throw new Error("Could not load patient profile");
      return response.json();
    }
    
    // Load consultation history for logged-in patient
    async function loadConsultationHistory() {
      try {
        const patient = await loadPatientProfile();
        const response = await fetch(`/api/consultations/patient/${patient.id}`, { headers: getAuthHeaders() });
        const consultations = await response.json();
        const listDiv = document.getElementById('consultationHistory');
        listDiv.innerHTML = '';
        consultations.forEach(c => {
          const item = document.createElement('div');
          item.className = 'list-item';
          
          // Add a Review button for COMPLETED consultations
          const reviewButton = c.status === 'COMPLETED' ? 
            `<button onclick="openRatingForm(${c.id})">Review</button>` : '';
          
          item.innerHTML = `
            <strong>ID:</strong> ${c.id} <br>
            <strong>Doctor:</strong> ${c.doctor.email} <br>
            <strong>Scheduled Time:</strong> ${c.scheduledTime} <br>
            <strong>Status:</strong> ${c.status} <br>
            <button onclick="editConsultation(${c.id}, ${c.doctor.id})" ${c.status !== 'PENDING' ? 'disabled' : ''}>Edit</button>
            ${c.status === 'WAITING_FOR_PATIENT_CONFIRMATION' ? `
              <button onclick="acceptChange(${c.id})">Accept Change</button>
              <button onclick="rejectChange(${c.id})">Reject Change</button>
            ` : ''}
            ${reviewButton}
          `;
          listDiv.appendChild(item);
        });
      } catch (error) {
        console.error("Error loading consultation history", error);
      }
    }
    
    // Open modal to edit consultation's schedule
    let currentConsultationId = null;
    function editConsultation(consultationId, doctorId) {
      currentConsultationId = consultationId;
      loadModalSchedules(doctorId);
      document.getElementById('editScheduleModal').style.display = 'block';
    }
    
    // Load schedules for modal selection
    async function loadModalSchedules(doctorId) {
      try {
        const response = await fetch(`/api/schedules/doctor/${doctorId}`, { headers: getAuthHeaders() });
        const schedules = await response.json();
        const modalSelect = document.getElementById('modalScheduleSelect');
        modalSelect.innerHTML = '';
        schedules.filter(schedule => schedule.status === "AVAILABLE")
                 .forEach(schedule => {
          const option = document.createElement('option');
          option.value = schedule.id;
          option.textContent = schedule.timeslot || `Schedule ${schedule.id}`;
          modalSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading modal schedules', error);
      }
    }
    
    // Handle modal Save Changes button
    document.getElementById('modalSubmitBtn').addEventListener('click', function() {
      const selected = document.getElementById('modalScheduleSelect').value;
      if (!selected) return alert("Please choose a schedule");
      fetch(`/api/consultations/${currentConsultationId}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify({ schedule: { id: selected }, status: "PENDING" })
      })
      .then(res => res.json())
      .then(result => {
        alert("Consultation updated: " + JSON.stringify(result));
        loadConsultationHistory();
        document.getElementById('editScheduleModal').style.display = 'none';
      })
      .catch(err => {
        console.error(err);
        alert("Error updating consultation");
      });
    });
    
    // Handle modal Cancel button
    document.getElementById('modalCancelBtn').addEventListener('click', function() {
      document.getElementById('editScheduleModal').style.display = 'none';
    });
    
    // Accept change for consultation
    function acceptChange(consultationId) {
      fetch(`/api/consultations/${consultationId}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify({ status: "APPROVED" })
      })
      .then(res => res.json())
      .then(result => {
        alert("Change accepted");
        loadConsultationHistory();
      })
      .catch(error => {
        console.error("Error accepting change:", error);
        alert(error);
      });
    }
    
    // Reject change for consultation
    function rejectChange(consultationId) {
      fetch(`/api/consultations/${consultationId}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        body: JSON.stringify({ status: "REJECTED" })
      })
      .then(res => res.text())
      .then(text => {
        const result = text ? JSON.parse(text) : {};
        alert("Change rejected");
        loadConsultationHistory();
      })
      .catch(error => {
        console.error("Error rejecting change:", error);
        alert(error);
      });
    }
    
    // When doctor selection changes, reload schedules for that doctor
    document.querySelector('select[name="doctorId"]').addEventListener('change', function() {
      loadSchedulesForDoctor(this.value);
    });
    
    // Initial load
    loadDoctors();
    loadConsultationHistory();
    
    // Add rating setup to page load
    document.addEventListener('DOMContentLoaded', function() {
      // Show rating form if this is a completed consultation
      checkCompletedConsultation();
      
      // Setup rating form submission
      const ratingForm = document.getElementById('ratingForm');
      if (ratingForm) {
        ratingForm.addEventListener('submit', handleRatingSubmit);
      }
    });
    
    function openRatingForm(consultationId) {
      // Show the rating section
      document.getElementById('ratingSection').style.display = 'block';
      
      // Scroll to the rating section
      document.getElementById('ratingSection').scrollIntoView({ behavior: 'smooth' });
      
      // Set the consultation ID in the form
      document.getElementById('consultationId').value = consultationId;
      
      // NEW ASYNC TECHNIQUE: Promise.all for parallel API calls
      // Get both the consultation details and any existing rating simultaneously
      Promise.all([
        // First promise: get consultation details to know the doctor
        fetch(`/api/v1/consultations/${consultationId}`, { 
          headers: getAuthHeaders() 
        }).then(res => res.json()),
        
        // Second promise: check if there's an existing rating
        fetch(`/api/v1/ratings/consultation/${consultationId}`, { 
          headers: getAuthHeaders() 
        }).then(res => res.status === 200 ? res.json() : null)
      ])
      .then(([consultation, existingRating]) => {
        // Show doctor's name in the rating form
        const ratingHeader = document.querySelector('#ratingSection .card-header h4');
        ratingHeader.textContent = `Rate Dr. ${consultation.doctor.name}`;
        
        // If there's an existing rating, pre-fill the form
        if (existingRating) {
          document.querySelector(`input[name="score"][value="${existingRating.score}"]`).checked = true;
          document.getElementById('review').value = existingRating.review;
          document.getElementById('submitRating').textContent = 'Update Rating';
          document.getElementById('ratingForm').dataset.ratingId = existingRating.id;
        }
        
        // Also fetch the doctor's average rating
        return fetch(`/api/v1/ratings/doctor/${consultation.doctor.id}/average`, {
          headers: getAuthHeaders()
        }).then(res => res.json());
      })
      .then(avgRating => {
        // Add average rating comparison to form
        const compareText = document.createElement('p');
        compareText.className = 'text-muted mt-2';
        compareText.textContent = `Average rating for this doctor: ${avgRating.toFixed(1)}/5`;
        document.querySelector('.rating-stars').appendChild(compareText);
      })
      .catch(error => {
        console.error('Error loading rating data:', error);
      });
    }
  </script>
</body>
</html>